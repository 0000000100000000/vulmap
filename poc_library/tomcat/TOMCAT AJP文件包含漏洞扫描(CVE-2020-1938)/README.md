### 一 漏洞描述
Tomcat AJP Connector 是什么？  
Tomcat Connector 是 Tomcat 与外部连接的通道，它使得 Catalina 能够接收来自外部的请求，传递给对应的 Web 应用程序处理，并返回请求的响应结果。  
默认情况下，Tomcat 配置了两个 Connector，它们分别是 HTTP Connector 和 AJP Connector：  
HTTP Connector：用于处理 HTTP 协议的请求（HTTP/1.1），默认监听地址为 0.0.0.0:8080  
AJP Connector：用于处理 AJP 协议的请求（AJP/1.3），默认监听地址为 0.0.0.0:8009  

HTTP Connector 就是用来提供我们经常用到的 HTTP Web 服务。而 AJP Connector，它使用的是 AJP 协议（Apache Jserv Protocol）  
AJP 协议可以理解为 HTTP 协议的二进制性能优化版本，它能降低 HTTP 请求的处理成本，因此主要在需要集群、反向代理的场景被使用。

通过 Ghostcat 漏洞，攻击者可以读取 Tomcat所有 webapp目录下的任意文件。  
此外如果网站应用提供文件上传的功能，攻击者可以先向服务端上传一个内容含有恶意 JSP 脚本代码的文件（上传的文件本身可以是任意类型的文件，比如图片、纯文本文件等），然后利用 Ghostcat 漏洞进行文件包含，从而达到代码执行的危害。  

影响范围：
Apache Tomcat 9.x < 9.0.31  
Apache Tomcat 8.x < 8.5.51  
Apache Tomcat 7.x < 7.0.100  

### 二 漏洞利用
tomcat ajp 协议发送
```
{'name': 'req_attribute', 'value': ['javax.servlet.include.path_info',f'{file_path}']}
```

### 三 漏洞修复
1. 如果未使用 Tomcat AJP 协议：  
如果确定未使用 Tomcat AJP 协议，则可以直接将 Tomcat 升级到 9.0.31、8.5.51 或 7.0.100 版本进行漏洞修复。  
而对于确定未使用 Tomcat AJP 协议，但无法进行版本更新、或者是更老版本的用户，可以考虑直接关闭 AJP Connector，或将其监听地址改为仅监听在本机 localhost

2. 如果使用了 Tomcat AJP 协议：  
如果确定服务器环境中使用到了 Tomcat AJP 协议，则建议将 Tomcat 升级到 9.0.31、8.5.51 或 7.0.100 版本，同时为 AJP Connector 配置 secret 来设置 AJP 协议认证凭证。

> 参考链接
> https://www.chaitin.cn/zh/ghostcat
